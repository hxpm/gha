name: check-types

on:
    workflow_call:
        inputs:
            cache-key:
                required: true

                type: string

            docker-service:
                required: true

                type: string

            project-name:
                required: true

                type: string

jobs:
    check-types:
        name: Types

        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4

            - uses: actions/cache@v3

              with:
                  key: ${{ github.job }}-${{ inputs.cache-key }}

                  path: |
                      _build
                      deps

            - uses: docker/login-action@v3

              with:
                  password: ${{ secrets.GITHUB_TOKEN }}

                  registry: ghcr.io

                  username: ${{ github.actor }}

            - name: Pull docker images

              run: |
                  docker-compose \
                    -f ./.docker/docker-compose.yaml \
                    -f ./.docker/docker-compose-gha.yaml \
                    pull

            - name: Install dependencies

              run: |
                  docker-compose \
                    -f ./.docker/docker-compose.yaml \
                    -f ./.docker/docker-compose-gha.yaml \
                    run ${{ inputs.docker-service }} \
                    mix deps.get

            - name: Compile application

              run: |
                  docker-compose \
                    -f ./.docker/docker-compose.yaml \
                    -f ./.docker/docker-compose-gha.yaml \
                    run ${{ inputs.docker-service }} \
                    mix compile --warnings-as-errors

            - name: Check types

              run: |
                  docker-compose \
                    -f ./.docker/docker-compose.yaml \
                    -f ./.docker/docker-compose-gha.yaml \
                    run ${{ inputs.docker-service }} \
                    mix dialyzer --format github

            - name: Clean up build

              run: |
                  docker-compose \
                    -f ./.docker/docker-compose.yaml \
                    -f ./.docker/docker-compose-gha.yaml \
                    run ${{ inputs.docker-service }} \
                    rm -rf ./_build/dev/lib/${{ inputs.project-name }}
